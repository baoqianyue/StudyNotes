# 数据库恢复技术      


## 事务    
事务是一系列数据库操作，是数据库应用程序的基本逻辑单元，这些操作要不都做，要不都不做，是一个不可分割的工作单位，在一个关系数据库中，一个事务有可能是一条SQL语句，一组SQL语句或是一段程序。         

事务和程序是两个概念，一般的，一个程序中包含多个事务。     

事务一般是由数据库管理系统去开启，我们也可以显示的开启：    

```SQL
BEGIN TRANSACTION; //开启一个事务
COMMIT; //提交事务 
ROLLBACK; //事务回滚
```          


## 事务的ACID原则     

* 原子性     
    事务是数据库的逻辑工作单位，其中的操作要不都不做，要不都做。     
* 一致性    
    事务执行的结果必须是从一个一致性状态变道另一个一致性状态。       
    要是一个事务中的有些操作做了，有些操作没有做，事务就无法正常提交，这时数据库就处于不一致状态，而且也不符合事务的原子性      
* 隔离性       
    一个事务的执行不能被其他事务所干扰，即一个事务的内部操作及使用的数据对其他的并发事务是隔离的。
* 持续性   
    一个事务一旦提交，则对数据库中相应数据的改变是永久性的。    

* 事务被破坏的因素：   
    * 多个事务并行运行时，不同的事务的操作交叉进行    
    * 事务在运行过程中被强行停止    


## 数据库故障       

* 事务故障   

    事务故障意味着事务没有达到预期的终点(commit或者显示的rollback)，因此数据库可能处于不正确状态，恢复程序要在不影响其他事务运行的情况下，强行回滚该事务，即撤销该事务已经做出的任何对数据库的修改，使得该事务好像根本没有启动一样，这类恢复操作称为事务撤销。

* 系统故障(软故障)   

    指的是数据库管理系统因为断电，DBMS代码故障，操作系统故障等导致数据库管理系统重启，这种故障不会破坏数据库。   

* 介质故障(硬故障)    

    如磁盘破坏，磁头碰撞等，会严重破坏数据库。     

## 恢复的实现技术    

数据库恢复技术其实就是使用了冗余    

* 数据转储    
    数据库管理员定期的将数据库复制到磁盘上，这些备用的数据称为后备副本     

    * 静态转储    
        只能在数据库没有事务运行时进行。    
    * 动态转储    
        指在转储期间可以对数据库进行修改，但是需要把转储期间各事务对数据库的修改活动记录下来，建立日志文件，这样在数据库被破坏时，后援副本加上日志文件就能把数据库恢复到正确状态。    

* 登记日志文件       

    * 日志文件的作用    
        * 事务故障恢复和系统故障恢复必须用日志文件     
        * 在动态转储方式中必须建立日志文件，后备副本加上登记日志文件才能有效的恢复数据库        

    * 登记日志文件      
        为了保证数据库是可恢复的，登记日志文件必须遵循两条原则：    
        * 登记的次序严格按并发事务执行的时间次序   
        * 必须先写日志文件，再写数据库修改       

            把对数据的修改写道数据库中和把表示这个修改的日志记录写到日志文件是两个不同的操作，有可能在这两个操作之间发生故障，即这个写操作只完成了一个，如果先写了数据库修改，而在运行记录中没有登记这个修改，则以后就无法恢复这个修改了，如果先写日志，但没有修改数据库，按日志文件恢复时只不过多执行了一次不必要的UNDO操作，并不会影响数据库正确性，所以为了安全，一定要先写日志文件，即先把日志记录写到日志文件中。   



    



    



